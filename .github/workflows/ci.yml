name: "[ Github Action ] Continus Integration "
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test: 
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v2

      - name: ğŸ“¦ Setup Node.js for use with actions
        uses: actions/setup-node@v1.1.0
        with:
          version: '12.x'

      - name: â³ Install node modules
        run: npm run ci

      - name: ğŸ¥¾ Run integration tests
        run: npm run test
      ## If you use cypress then enabled this option
      # Start the web server so that cypress can run e2e tests against it. Notice "&" at end, this ensures it's run in the background.
      # - name: Start web server
      #   run: npm start &

      # - name: Run e2e tests
      #   run: npm run test:e2e

      - name: Collecting Code Coverage
        uses: codecov/codecov-action@v1
      
      - name: if fail
        uses: actions/github-script@v3.1.1
        with:
          github-token: ${{github.token}}
          script: |
            const ref = "${{github.ref}}"
            const pull_number = Number(ref.split("/")[2])
            await github.pulls.createReview({
              ...context.repo,
              pull_number,
              body:"Check your test",
              event: "REQUEST_CHANGES"
            })
        if: failure()

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v2

      - name: ğŸ“¦ Setup Node.js for use with actions
        uses: actions/setup-node@v1.1.0
        with:
          version: '12.x'

      - name: â³ Install node modules
        run: npm run ci

      - name: ğŸ¥¾ Run linter
        run: npm run lint

  ## If you use deployment flow then enabled this options
  # build:
  #   name: Build
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: âœ… Checkout repository
  #       uses: actions/checkout@v2

  #     - name: ğŸ“¦ Setup Node.js for use with actions
  #       uses: actions/setup-node@v1.1.0
  #       with:
  #         version: '12.x'

  #     - name: â³ Install node modules
  #       run: npm run ci

  #     - name: ğŸ¥¾ Create production build
  #       run: npm run build

  #     # Upload the build so that we can use it later
  #     - name: ğŸ•‹ Upload build folder
  #       uses: actions/upload-artifact@v1
  #       with:
  #         name: build
  #         path: build

  # deploy:
  #   name: Deploy
  #   # Only deploy if these other jobs have completed successfully
  #   needs: [test, lint, build]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: âœ… Checkout repository
  #       uses: actions/checkout@v2

  #     # Download the build folder from the earlier job and use it to deploy
  #     - name: â³ Download build folder
  #       uses: actions/download-artifact@v1
  #       with:
  #         name: build

  #     # Deploy to github pages
  #     - name: ğŸ—ºï¸ Deploy build
  #       uses: JamesIves/github-pages-deploy-action@releases/v3
  #       with:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_ACCESS_TOKEN }}
  #         BRANCH: gh-pages
  #         FOLDER: build